---
- name: AMD GPU Burn
  when:
    - ansible_distribution == 'Ubuntu'
    - ansible_distribution_major_version == '22'

  block:

    - name: Download CUDA pin with wget
      ansible.builtin.get_url:
        url: "https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-ubuntu2204.pin"
        dest: "/etc/apt/preferences.d/cuda-repository-pin-600"
        mode: '0644'


    - name: Download CUDA with wget
      ansible.builtin.get_url:
        url: "https://developer.download.nvidia.com/compute/cuda/12.4.1/local_installers/cuda-repo-ubuntu2204-12-4-local_12.4.1-550.54.15-1_amd64.deb"
        dest: "/tmp/cuda-repo-ubuntu2204-12-4-local_12.4.1-550.54.15-1_amd64.deb"
        mode: '0644'

    - name: Install cuda-repo-ubuntu2204
      ansible.builtin.apt:
        deb: /tmp/cuda-repo-ubuntu2204-12-4-local_12.4.1-550.54.15-1_amd64.deb


    - name: Copy keyring.gpg
      ansible.builtin.copy:
        src: "/var/cuda-repo-ubuntu2204-12-4-local/cuda-3F2FBBBE-keyring.gpg"
        dest: "/usr/share/keyrings/cuda-3F2FBBBE-keyring.gpg"
        remote_src: true
        mode: '0644'


    - name: Update apt-get repo and cache
      ansible.builtin.apt:
        update_cache: true
        force_apt_get: true


    - name: Install CUDA toolkit for Ubuntu
      ansible.builtin.apt:
        name: cuda-toolkit-12-4
        force_apt_get: true

    - name: Install CUDA toolkit for Ubuntu
      ansible.builtin.apt:
        name: cuda-drivers
        force_apt_get: true

    - name: Install libstdc
      ansible.builtin.apt:
        name: libstdc++-12-dev


    - name: Creates /opt/oci-hpc directory
      ansible.builtin.file:
        path: /opt/oci-hpc
        state: directory
        mode: '0755'


    - name: Clone a github repository
      ansible.builtin.git:
        repo: https://github.com/wilicc/gpu-burn
        dest: /opt/oci-hpc/gpu-burn
        clone: true
        update: true
        version: 9aefd7c0cc603bbc8c3c102f5338c6af26f8127c

    - name: Remove file (delete file)
      ansible.builtin.file:
        path: /opt/oci-hpc/gpu-burn/gpu_burn-drv.cpp
        state: absent

    - name: Download AMD GPU Burn 1
      ansible.builtin.get_url:
      url: >
        https://objectstorage.us-phoenix-1.oraclecloud.com/p/7OUXouKRlH5owhkrzXXJJnUxCuaITeM3DWp08Q2m3aSrdNejB3leJWdPGjN5CeZ8/n/hpc/b/rik-uploads/o/gpu_burn-drv.cpp
      dest: "/opt/oci-hpc/gpu-burn/gpu_burn-drv.cpp"
      mode: '0644'

    - name: Download AMD GPU Burn 2
      ansible.builtin.get_url:
      url: >
        "https://objectstorage.us-phoenix-1.oraclecloud.com/p/7OUXouKRlH5owhkrzXXJJnUxCuaITeM3DWp08Q2m3aSrdNejB3leJWdPGjN5CeZ8/n/hpc/b/rik-uploads/o/Makefile.amd"
      dest: /opt/oci-hpc/gpu-burn/Makefile.amd"

    - name: Build and check the link
      ansible.builtin.shell: |
        make -f Makefile.amd clean
      register: clean_output
      args:
        chdir: "/opt/oci-hpc/gpu-burn"
      changed_when: clean_output.rc != 0

    - name: Build and check the link
      ansible.builtin.shell: |
        make -f Makefile.amd
      register: build_output
      args:
        chdir: "/opt/oci-hpc/gpu-burn"
      changed_when: build_output.rc != 0

    - name: Apt autoremove
      ansible.builtin.apt:
        autoremove: true
