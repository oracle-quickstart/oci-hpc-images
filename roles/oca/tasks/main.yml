---
- name: Edit the shapes.json
  when: "'use_plugins' in options"
  block:
#    - name: Edit the shapes.json file
          #      copy:
          #        src: 'shapes.json'
          #        dest: '/etc/oracle-cloud-agent/plugins/oci-hpc/oci-hpc-configure/shapes.json'
          #      when: ansible_os_family == 'RedHat'
          #    - name: Edit the shapes.json file
          #      copy:
          #        src: 'shapes_ubuntu.json'
          #        dest: '/etc/oracle-cloud-agent/plugins/oci-hpc/oci-hpc-configure/shapes.json'
          #      when : ansible_distribution == 'Ubuntu'
    - name: Edit the shapes.json file
      ansible.builtin.copy:
        src: 'rdma_network.json'
        dest: '/etc/oracle-cloud-agent/plugins/oci-hpc/oci-hpc-configure/rdma_network.json'
        mode: '0644'
      when: ansible_os_family == 'RedHat'

    - name: Edit the shapes.json file
      ansible.builtin.copy:
        src: 'rdma_network_ubuntu.json'
        dest: '/etc/oracle-cloud-agent/plugins/oci-hpc/oci-hpc-configure/rdma_network.json'
        mode: '0644'
      when: ansible_distribution == 'Ubuntu'

    - name: Install latest OCA for OL # noqa package-latest
      ansible.builtin.yum:
        name: oracle-cloud-agent
        state: latest
        disable_gpg_check: true
      when:
        - ansible_os_family == 'RedHat'

    - name: Install yum-plugin-versionlock for OL7
      ansible.builtin.dnf:
        name: yum-plugin-versionlock
        state: present
        disable_gpg_check: true
      when:
        - ansible_os_family == 'RedHat' and ansible_distribution_major_version == '7'

    - name: Install yum-plugin-versionlock for OL8
      ansible.builtin.dnf:
        name: python3-dnf-plugin-versionlock
        state: present
        disable_gpg_check: true
      when:
        - ansible_os_family == 'RedHat' and ansible_distribution_major_version == '8'

    - name: Hold latest OCA for OL
      community.general.yum_versionlock:
        name: oracle-cloud-agent
        state: present
      when:
        - ansible_os_family == 'RedHat'

    - name: Snap update # noqa command-instead-of-shell no-changed-when
      ansible.builtin.shell: "sudo snap refresh --channel=1.42.x/stable oracle-cloud-agent"
      when: ansible_distribution == 'Ubuntu'

    - name: Hold Oracle cloud-agent # noqa command-instead-of-shell no-changed-when
      ansible.builtin.shell: "sudo snap refresh --hold=forever oracle-cloud-agent"
      when: ansible_distribution == 'Ubuntu'

    - name: Disable OCA updater
      ansible.builtin.replace:
        path: /etc/oracle-cloud-agent/updater.yml
        regexp: 'upgrade_interval: 3600'
        replace: 'upgrade_interval: -1'
